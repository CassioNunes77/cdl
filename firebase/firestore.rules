rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Public collection of campaigns (readable by anyone)
    match /campaigns/{campaignId} {
      // Public: anyone can read campaigns
      allow get, list: if true;

      // Writes only allowed for admins
      allow create, update, delete: if isAdmin();
    }

    // Optional admin marker collection. Documents here should be created
    // only by trusted server-side code or manually via Firebase Console.
    // The doc id SHOULD be the auth uid of the admin user.
    match /admins/{adminId} {
      // Client can only get their own doc (to check "am I admin?"). No list.
      allow get: if request.auth != null && request.auth.uid == adminId;
      allow list, write: if false;
    }

    // News: public read published only; admin read/write all
    match /news/{newsId} {
      allow get, list: if resource.data.published == true || isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // Site settings: public read; admin write
    match /settings/{docId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // Deny anything else by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Helper function: user is admin if:
    // - authenticated AND has custom claim `admin == true`, OR
    // - authenticated AND a document exists at /admins/{uid}
    function isAdmin() {
      return request.auth != null &&
        (request.auth.token.admin == true ||
         exists(/databases/$(database)/documents/admins/$(request.auth.uid)));
    }
  }
}

